## 邮件的优先级特征
如果你使用Google的Gmail服务的话，那么就会知道“优先邮件箱”的概念是Google在2010年的时候首次普及的。当然，就是这个问题启发了这一章中的排名的案例研究，所以重新回顾一下Google在他们的排名算法中使用的方法是很有用的，以便于我们可以设计我们自己的算法。幸运的是，在Google公布优先收件箱功能的几个月之后，他们发表了一篇题为“Gmail优先收件箱背后的学习机制”的论文，其中描述了他们设计有监督学习的方法和如何将其应用在[DA10]范围的策略。考虑到这一章的目的，我们只对前者感兴趣，但是我强烈推荐将这篇论文作为我们这里所讨论的补充材料。真的非常值得花时间在那四页的内容上。  

如我们所提到的，如何度量时间是关键。在Google的案例中，他们有用户与邮件交互的很长的详细历史记录。Google的优先收件箱会尝试预测用户对一封邮件在该邮件被投递给这个用户后几秒内进行操作的可能性。在Gmail中用户可以进行的操作有很多：阅读，回复，标记不标签等。而且，*投递*并不是明确的指一封邮件由服务器接收的时间，而是其被投递给用户的时间——即用户检查邮箱的时间。  

如同垃圾邮件分类那样，这也是一个描述起来相对简单的问题：已知邮件的特征集和用户刚刚查看邮箱的先验知识，这个用户在最小和最大的秒数之间会进行一些可能的操作的概率是多少？  

在邮件可能的特征集内，Google集中于其中的哪些特征呢？你可能会预计这他们选择了很多的特征。那篇论文的作者这样写到，与垃圾邮件分类不同，垃圾邮件分类中几乎对所有用户都会用同样的代码，但是我们对每个用户都会有不同的邮件排序方式。已知用户是如何评价特征集的变化性，Google的方法需要包含多个特征。在开始设计算法的时候，Google的工程师们探索了各种各样不同类型的邮件特征，他们的描述如下：  

> 有一些类别有成百上千的特征。*社交特征*是基于发送者和接收者的交互程度的，例如，接收者阅读发送者邮件的比例。*内容特征*尝试识别邮件主题和与最近接收者的邮件行为有较高相关度的措辞，比如，出现了邮件主题中近期的措辞。用户近期措辞的发现是学习的一个预处理步骤。*线程特征*会注意用户与这个线程目前的交互，比如，是否是用户开始了线程。*标签特征*会检查用户应用与邮件过滤的标签。我们在排序中计算了特征值，并将这些特征值暂时存储起来以供之后的学习中使用。连续型特征会根据特征值的直方图使用ID3类的算法自动的分成二元特征。  

如同我们刚刚提及的，Google有用户与Gmail进行交互的很长的历史记录，这就使他们可以拥有一个对用户将何时如何处理邮件的很丰富的视角。不幸的是，我们在这个练习中并没有这样详细的邮件信息。我们会再次用SpamAssassin公共语料库代替，可以在*[http://spamassassin.apache.org/publiccorpus/](http://spamassassin.apache.org/publiccorpus/)*中免费下载。  

虽然这个数据集是为了测试垃圾邮件分类算法而发布的，但是他也包含了一个用户邮件的便捷时间轴。给定这个单线程，我们就可以将这个数据集的目的改为去设计和测试一个优先邮件排名系统。此外，我们只集中于来自这个数据集的有用的邮件，这样我们就知道我们将会检查的所有消息都是用户在收件箱中想要的邮件。  

然而在我们执行之前，我们必须要考虑到我们的数据与一个像Google那样完整详细的邮件记录有什么不同，以及这会怎样影响我们将在算法中可以使用的特征。让我们以回顾Google提出的四个类别，以及这样的分类可以怎样的适应我们用的数据开始。  

> 完整详细的邮件信息与我们将会使用的信息的最关键不同的地方是我们只能看到接收到的消息。这就意味着我们实际上会在“眼半瞎”的情况下进行，因为我们没有用户是何时怎样对邮件进行响应的信息，也不知道用户是不是这个线程的发起人。这是个*显著的限制*，所以在这章中用到的方法和算法应该只被看作是练习，而不是一个企业级优先收件箱系统的运行示例。我们想要达成的是展示即便有这样的限制，我们可以怎样的用我们有的数据建立一个邮件重要性替代度量并设计一个相对较好的排名系统。  

既然邮件是一个基于事务的媒介，于是社交特征就成了评价一封邮件重要性的最重要特征。然而在我们这个案例中，我们只能看到事务的一半。在信息完整详细的情况下，我们会想要度量用户与各种各样邮件的发送者的交互量来得知哪些发送者的邮件得到这个用户更快的操作。然而对于我们的数据，我们只能度量接收量。因此我们可以假设这个单向量是我们试图从数据中提取的社交特征的好替代。  

很明显这不会是理想的。然而要记住这个练习中我们只用到来自SpamAssassin公共语料库中的有用消息。如果一个人从一个地址接收了大量的有用消息，那么发送者就可能与这个用户有很强的社交关系。还有一种情况就是也有可能这个用户在一个邮件列表中注册订阅，并且希望这些邮件不会以一个较高的优先级接收。这就是为什么我们在建立排名系统的时候必须要包含其他特征来平衡这种信息。  

只考虑来自一个给定地址的邮件量的一个问题就是临时成分被延长了。因为我们的数据集相对于一个完整详细的邮件记录是静态的，我们必须将数据分隔成临时的片段，通过测量这些段落的量以达到对这种临时动态的更好的解释。  

就如同我们将接下来会详细讨论的，对于这个练习，我们简单地将所有信息按时间排序，然后将集合分成两半。第一半将被用来训练排名算法，第二半被用来测试。就其本身而言，训练数据集覆盖的整个时段中，来自每个邮件地址的消息量将会被用来训练我们排名系统的社交特征。  

知道了我们数据的本质，这可能是个好的开始，但是我们需要更加深入的了解我们是否希望将消息排序更加精确。分割数据以得到这些动态的更细粒度视图的一种方法是去识别对话线程，然后度量线程内活动。（为了识别线程，我们可以参考其他的邮件客户端使用的技术，然后用关键线程措辞与消息主题进行匹配，例如“RE:”。）虽然我们不知道用户对一个线程进行的是怎样的操作，但是我们在这里做一个假设：如果线程很活跃，那么这个线程就很可能比那些相对不那么活跃的线程更重要。通过将那些临时的分隔的数据成小片段，我们就可以得到需要建模的邮件优先级线程特征的一个更精确的替代度量。  

下一步，我们可以从邮件中提取很多内容特征到特征集中。在这种情况中，我们会继续通过扩展在第三章中使用的文本挖掘技术到当前环境以保持一切相对简单。特别的是，如果在用户收到的邮件主题和内容中有经常出现的措辞，那么将来的那些在主题和内容中包括这些措辞的邮件就可能比那些不包括的更重要。这实际上是一个非常常见的技术，而且在Google的优先收件箱中有简要提到过。通过增加基于邮件主题和内容措辞的内容特征，我们就会遇到一个*权重*的有趣问题。有代表性的是，邮件主题中的措辞会比内容中的相对少很多；因此，我们不能把两种特征中初相的公共措辞的相对重要性赋予相同权重。  

最后，在企业级优先收件箱实现——像Gmail——中还有很多特征我们在这个练习中是得不到的。我们之前提过我们不知道大部分的社交特征集，因此必须使用替代来测量这些交互。此外，还有很多用户操作我们是没有办法近似估计的。例如，用户的标记标签或者移动邮件信息，这些操作会占操作集很大的比例，但是它们在这里却被完全的忽视了，事实上忽视这些操作并不会对我们的结果造成影响。  

我们现在已经有了一个我们将要用来建立邮件排名系统的特征集的基本蓝图。我们开始按时间为消息排序，因为在这种情况下，我们感兴趣预测的大部分内容都包含在这个临时的维度中。这些消息的一半用来训练我们的排名系统。然后，我们将在训练中用到四个特征。第一个就是社交特征的替代，即测量已知用户的训练数据的信息量。其次，通过查找线程来尝试压缩这个临时的度量，并将活跃线程排在不活跃线程之前。最后我们根据邮件主题和消息主体中的频繁措辞添加两个内容特征。图4-1是这些特征如何从一个邮件中提取出来的总结。

![Figure 4-1](images/figure 4-1.png?raw=true "Figure 1-1")  

在下一节，我们就会执行我们刚刚描述的优先收件箱方法。应用上面列出的特征，我们就可以特化出一个试图快速将更重要的消息推入栈顶的权重模式。像以前那样，我们首先进行的步骤是用原始邮件数据，提取重要的片段放入我们的特征集中。